## NAMD LAB 2: BUILDING AND SIMULATING A PROTEIN-BILAYER SYSTEM
###### by [Mitch Gleed](https://www.linkedin.com/in/mitchell-gleed-65a8b03b/)

---

#### Objectives:
- Learn to create a protein-bilayer system using the CHARMM-GUI membrane builder 
- Learn how to run pre-made CHARMM-GUI dynamics scripts 

---

> The first portion of this lab using CHARMM-GUI is something you can do at home, so if you would like more lab time for coding and simulation, we would recommend you complete section 1 of the lab beforehand.

In this lab we will be working with the same protein that we simulated in CHARMM labs 7 and 8, the Influenza A M2 protein. We construct the protein-bilayer system using CHARMM-GUI, a CHARMM web interface developed by Lehigh University. We will then use NAMD to equilibrate, CHARMM to insert a drug of choice, VMD to create comparison sets for NAMD restraints, and then perform production dynamics in NAMD. 

This lab is a preparation lab for the Umbrella Sampling lab, which will use trajectories you simulate in this lab and rely heavily on code you create as well. To this end, there are actually a few points of flexibility in the lab, so depending on if you are doing this lab with other students in a class setting, you might each pick slightly different, but related, options so that you can compare results in the end (like a small research study!). Take a moment with your class and decide what each class member will do differently and what variables should remain the same. Here are just a few of many examples of components where you will have flexibility:
- **M2 PDB**. Ex: Compare free-energy profiles of a particular M2 blocker between different M2 structures on the protein data bank.
- **M2 protonation state**. Ex: Compare the free-energy profiles of a particular M2 blocker with varying His37 protonation states (count, type) of the same M2 structure.
- **M2 mutations**. Ex: Compare free-energy profiles of a particular M2 blocker between WT, S31N, V27A variants of the same M2 structure.
- **M2 blockers**. Ex: Compare free-energy profiles of varying M2 blockers, such as Amantadine, Rimantadine, etc. with the same M2 structure.
- **M2 blocker properties**. Ex: Compare free-energy profiles of deprotonated vs. protonated or L- vs. R-chiral M2 blockers with the same M2 structure.
- **Restraints**. Ex: Investigate the impact of varying strengths of peptide backbone restraints on a specific drug's free-energy profile with the same M2 structure.
- **Membrane composition**. Ex: Investigate the impact of varying lipid membrane composition on the free-energy profile of a specific M2 blocker with the same M2 structure.
- **Reaction coordinate**. Ex: Investigate the difference between a coordinate bias and distance bias; e.g., sampling in Z-axial cartesian space -30 to 30 Ang vs. sampling in relative Z-axial distance from a central residue, e.g. His37, -30 to 30 Ang.


### 1. CHARMM-GUI 

Navigate to [http://www.charmm-gui.org](http://www.charmm-gui.org). Select `Input Generator` in the navigation bar, then select `Membrane Builder` > `Bilayer Builder` in the updated navigation bar. Scroll down to `Protein/Membrane System` and enter the M2 PDB protein code of your choice. Average structures have been built for all of the following structures--for the sake of ease you may choose between these, otherwise you will need to modify the restraint protocol used in this lab involving averaged PDB structures.

- **2LY0**. [Solution NMR structure of the influenza A virus S31N mutant (19-49) in presence of drug M2WJ332](http://www.pnas.org/content/110/4/1315)
- **2L0J**. [Solid State NMR structure of the M2 proton channel from Influenza A Virus in hydrated lipid bilayer](http://science.sciencemag.org/content/330/6003/509)
- **2L0J S31N**. Generated by CHARMM-GUI from the above structure 
- **2KIX**. [Channel domain of BM2 protein from influenza B virus](https://www.nature.com/articles/nsmb.1707)
- **2KQT**. [Solid-state NMR structure of the M2 transmembrane peptide of the influenza A virus in DMPC lipid bilayers bound to deuterated amantadine](https://www.nature.com/articles/nature08722)
- **2KQT S31N**. Generated by CHARMM-GUI from the above structure. Used in some of our lab's publications, including [Gleed, et al. 2015](http://pubs.acs.org/doi/abs/10.1021/acs.jpcb.5b05808).

Once you have entered the PDBID of your choice, ensure `Download Source` is set to "OPM", and then scroll down to and click `Next Step: Select Model/Chain`.

#### Select Model/Chain 
- Model 1 should be selected and `Read all models?` should be unchecked
- Only protein segments should be checked (`Hetero` should all be unchecked)

#### Manipulate PDB 
All of the boxes here should be unchecked except for the following: 
- **Terminal group patching**. The four M2 segments should be patched at the N and C termini by default when checked. 
- **Mutation**. Here is where you can mutate certain residues, e.g. Ser 31 -> Asn 31. Ensure you mutate all four segments (PROA, PROB, PROC, PROD). **You also use this to set Histidine protonation, see discussion below.** Click on `Add Mutation` to add more mutations.

The protonation box is limited, and we prefer to use the mutation feature to set His protonation states. You must set His protonation for all occurences in the peptide. For example, the 2KQT structure has one His residue on each M2 segment, for a total of four; 2L0J, on the other hand, has two on each segment, for a total of eight. We have used the HSE epsilon protonation state for His37 in our lab publications, so we suggest you use that here.

For 2KQT, it should look like the following: 

| SEGID | RESID | AA  | Mut |
| ----- | ----- | --- | --- |
| PROA  | 37    | HIS | HSE |
| PROB  | 37    | HIS | HSE |
| PROC  | 37    | HIS | HSE |
| PROD  | 37    | HIS | HSE |

Amino acid mutations such as S31N would be performed similar to the above table. 

#### Generate PDB and Orient Molecule
- If using an OPM orientation of the PDB (set in the first step when you entered the PDB ID), select `Use PDB Orientation`, otherwise select `Align the First Principal Axis Along Z`
- Check `Generate Pore Water and Measure Pore Size`

#### Calculate Cross-Sectional Area
In this portion, you will decide which type of lipids to use and what type and size of system you want. 

- Under `1. Box Type`, select `Hexagonal`. You can elect to use `Rectangular`, but for the purposes of this lab we will add the ability to manage a hexagonal simulation crystal to your repetoire, should you choose to use one or find a need to use one in your simulations. Hexagonal boxes reduce the size of a protein-bilayer system without compromising results, as it eliminates the unneeded water and lipids most distant from the central protein in the corners of a rectangular box. For most purposes, however, (probably including in publications) we recommend using a rectagonal box, as this is the standard.
- Leave `2. Length of Z based on` and `3. Length of XY based on` default, but take a look at what these are adjusting. 
- Enter `60` in the box after `Length of X and Y`
- Click the arrowhead next to `PC (phosphatidylcholine ) Lipids` and enter `1` in the boxes under the headings `Upperleaflet Ratio (Integer)` and `Lowerleaflet Ratio (Integer)` for the lipid `DMPC`.
- Click the button `Show the system info`. A table on the right side of the page now appears and provides some data regarding the membrane to be constructed.

> As far as the membrane lipid composition goes, you will generally want to choose a lipid according to the lipid used in the study connected to the PDB. If you want to use this as a comparison in the umbrella sampling study, you could use homogenous membranes with varying lipids or varying mixtures of lipids, cholesterol, etc. by changing the lipid ratios in the upper and lower membrane leaflets. 

#### Determine the System Size 
- Ensure `Replacement method` is checked, as well as `Check lipid ring (and protein surface) penetration`
- Check `Include Ions` and set to `0.15 M NaCl` (as this is physiologically taking place within the endosome, in which sodium is the dominant cation), and then click the box `Calculate number of ions`
- Ensure `Ion Placing Method` is set to `Monte-Carlo`

> If you have time and want to publish using this CHARMM-GUI structure, consider following the extra instructions under `Pore Water Options`. Otherwise move on to the next step.

> This step typically takes the longest for CHARMM-GUI to process, and you may even get a blank white screen for a while. You might consider copying the link that shows just below the yellow CHARMM box in case of a time out.

#### Build Components
Click to continue

#### Assemble Components (1 of 2)
Click to continue

#### Assemble Components (2 of 2) 
> You can now view the ultimate system size. If you are hoping to publish using this structure, you might want to document some of these statistics. 

- `Force Field options` should be set to CHARMM36m if your CHARMM version is at least c42. As we will be using NAMD primarily in this lab, you can use CHARMM36m regardless of CHARMM version available to you.
- Check `NAMD` under `Input Generation Options` 
- Ensure `Generate grid information for PME FFT automatically` is enabled
- Ensure `NPT ensemble` is checked 
- Set the temperature to `310` K.

#### Generate Equilibration and Dynamics Inputs 
Click the red box labeled `download .tgz`, located near the top right corner of the Membrane Builder interface. This will download a file named `charmm-gui.tgz` to your system. Upload this file to your personal NAMD lab 2 directory on the supercomputer.

You may close CHARMM-GUI now.

### 2. Running generated equilibration input files in NAMD 

CHARMM-GUI provides output in multiple MD suite formats to automatically begin equilibrating the systems, and for this lab we will use the generated NAMD input files. The simulation parameters and restraints vary slightly between MD packages, but the simulations follow essentially the same pattern. 

The equilibration protocol involves progressive relaxation of restraints. Each step lasts 50 - 100 ps. The relaxation is performed as follows (per the CHARMM-GUI site):

|        | Step 1 | Step 2 | Step 3 | Step 4 | Step 5 | Step 6 |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| BB     |  10.0  | 5.0    | 2.5    | 1.0    | 0.5    | 0.1    |
| SC     |   5.0  | 2.5    | 1.0    | 0.5    | 0.1    | 0.0    |
| tforce |   2.5  | 1.0    | 0.5    | 0.0    | 0.0    | 0.0    |
| mforce |   2.5  | 0.0    | 0.0    | 0.0    | 0.0    | 0.0    |
| ion    |  10.0  | 0.0    | 0.0    | 0.0    | 0.0    | 0.0    |

- `BB`: force constant to keep RMSD of protein backbone atoms to original structure 
- `SC`: force constant to keep RMSD of protein sidechain atoms to original structure 
- `tforce`: force constant to keep the lipid tail below +/- %
- `mforce`: force constant to keep the lipid head groups close to target values
- `ion`: force constant to keep ions near original positions

Other restraints implemented include a barrier restraint to keep water molecules away from the hydrophobic lipid regions, dihedral restraints on lipids, etc.

#### Submitting NAMD GPU jobs

NAMD performs very well on standard Linux clusters, but is particularly fast when used on nodes with GPU's. A sample submission script titled "bash.pt1_equilibrate.sh" is provided for you, let's go ahead and start digging into it. Open the file and examine its contents.

You will see some familiar lines near the start that tell the scheduler what resources to ask for:
```bash 
#!/bin/bash

#SBATCH --time=18:00:00   # walltime
#SBATCH --ntasks=24   # number of processor cores (i.e. tasks)
#SBATCH --nodes=1   # number of nodes
#SBATCH --gres=gpu:4
#SBATCH --mem=64G   # memory per CPU core
```
This script is tailored to the architecture of the m8g cluster, which is comprised of nodes each with 24 processing cores, 4 GPU's, and 64 GB of RAM. The option `--gres=gpu:4` requests 4 GPU's.

We will use this script to modify the restraint protocol provided by CHARMM-GUI. To save time for the meat of the lab, we won't delve into the syntax of the section labeled `# Add a channel backbone tilt restraint...`, but it is appending an extra restraint to the NAMD equilibration protocol given by CHARMM-GUI to keep the channel axis lightly restrained to the Z axis using the `tilt` collective variable. 

To allow NAMD to use the GPU's, we need to give Linux an environment ready for GPU simulations. 

Append the following code beneath the line `# NAMD variables`:
```bash
# NAMD variables 
module purge
module load compiler_gnu/6.4
module load cuda/8.0
export dir=/fslhome/mgleed/software/namd/exec/NAMD_Git-2017-11-04_Linux-x86_64-multicore-CUDA
```
This will reset the environment with `module purge`, and give the libraries needed for GPU simulations with `compiler_gnu/6.4` and `cuda/8.0`. Finally, the directory containing the NAMD GPU-ready executable is given by the variable `dir`. 

Now we need to launch NAMD and load the input files. Append the following code beneath the line `# Run NAMD`:
```bash 
# Run NAMD 
cd $SLURM_SUBMIT_DIR/charmm-gui/namd
$dir/namd2 +p${SLURM_CPUS_ON_NODE} +idlepoll +devices "0,1,2,3" step6.1_equilibration.inp > step6.1_equilibration.inp.log
```
The `cd` command moves to the folder containing the NAMD input files. Using `cd` in a submission script will help prevent creating output files in a location you don't want. The next line is where NAMD is invoked. 
- `$dir/namd2` calls the NAMD executable
- `p${SLURM_CPUS_ON_NODE}` uses the number of CPU's on the node, which should be 24 if you use a whole m8g GPU node
- `+idlepoll` is a command used for optimizing jobs using GPU's
- `+devices "0,1,2,3"` asks for the GPU devices numbered 0 to 3 (4 GPU's)
- The next two parameters are the input and output files respectively, separated by a `>`

> There are simpler ways to run GPU jobs, but this is the fastest we've discovered for the m8g cluster based on a variety of benchmark results.

This submission script is nearly complete, but while we have the GPU node scheduled, let's go ahead and run all of the steps of equilibration, not just 6.1. *Create new lines for step 6.2 through 6.6, based on the last line, and append them to the end of the script.*

If you don't want to use GPU's for your simulation (such as when the GPU nodes have 100% utilization, [check the site](http://marylou.byu.edu)), remove the line containing `--gres`, reduce the number of processors, RAM, etc., and use the following pattern to launch jobs:
```bash 
# NAMD variables 
module purge 
module load namd/2.12_openmpi-1.8.5_gnu-5.2.0

# Run NAMD 
mpirun $(which namd2) step6.1_equilibration.inp > step6.1_equilibration.inp.log
```

> To learn more, see also [MaryLou compute resources](https://marylou.byu.edu/documentation/resources) to get an idea of what resources you can request and the [Job Script Generator](https://marylou.byu.edu/documentation/slurm/script-generator) to get the scheduler commands you need.



**[NAMD Lab 2](https://busathlab.github.io/mdlab/namd_lab2.html)**

**[Return to home page](https://busathlab.github.io/mdlab/index.html)**


